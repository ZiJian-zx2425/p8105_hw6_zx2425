---
title: "Simple document"
output: github_document

    
---
```{r,echo=FALSE, message=FALSE}
library(tidyverse)
library(patchwork)
library(p8105.datasets)
library(tidyverse)
library(modelr)
library(mgcv)
```

#let's begin
```{r}
set.seed(001)
```

#problem2
Create a _city_state_ variable (e.g. “Baltimore, MD”), and _a binary variable_ indicating whether the homicide is solved. 
```{r}
homicide = read.csv("./homicide-data.csv") 

homicide=homicide%>% 
  na.omit() %>% 
  mutate(
    city_state=str_c(city,",",state)
  ) %>% 
  mutate(solve_sit = case_when(
    disposition== "Closed by arrest" ~ 1,
    disposition== "Open/No arrest" ~ 0)) %>% 
 mutate(
   unsolved = case_when(
     disposition== "Closed by arrest" ~ 0,
    disposition== "Open/No arrest" ~ 1))%>% 
  na.omit() 
                          
```



Omit cities Dallas, TX; Phoenix, AZ; and Kansas City, MO – these don’t report victim race. Also omit Tulsa, AL – this is a data entry mistake. For this problem, limit your analysis those for whom victim_race is white or black. Be sure that victim_age is numeric.

```{r}
homicide =homicide%>% 
filter(!city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")) %>% 
  filter(str_detect(victim_race, c("White", "Black"))) %>% 
  mutate(victim_age =as.numeric(victim_age))%>% 
  na.omit()
```

For the city of Baltimore, MD, use the glm function to fit a logistic regression with _resolved vs unresolved_ as the outcome and _victim_ _age_, _sex_ and _race_ as predictors. Save the output of glm as an R object; 
```{r}
data_B= filter(homicide,city_state=="Baltimore,MD")
data_B_model = data_B%>% 
  glm(solve_sit ~ victim_age + victim_race + victim_sex, data = ., family = binomial())

data_B_model %>% 
  broom::tidy(conf.int = TRUE) %>% 
  mutate(OR = exp(estimate), 
  conf_low=exp(estimate-1.96*std.error), 
  conf_high=exp(estimate+1.96*std.error)
  ) %>%
  select(term, log_OR = estimate, OR, p.value, conf_low, conf_high) %>% 
  knitr::kable(digits = 3)
##
exp(summary(data_B_model)$coefficients["victim_sexMale",1] + qnorm(c(0.025,0.5,0.975)) * summary(data_B_model)$coefficients["victim_sexMale",2])
```
Create a plot that shows the estimated ORs and CIs for each city. Organize cities according to estimated OR, and comment on the plot.
```{r}
all_city_model = 
  homicide %>%
  nest(data = -city_state) %>% 
  mutate(
    logmodel = map(data, ~glm(solve_sit~victim_age + victim_race + victim_sex, family = binomial(), data = ., )),
     result = map(.x=logmodel, ~broom::tidy(.x,conf.int = TRUE))) %>% 
  select(-data,-logmodel)%>% 
  unnest(result)%>% 
  mutate(
    OR = exp(estimate), 
    conf_low=exp(estimate-1.96*std.error), 
    conf_high=exp(estimate+1.96*std.error)
    ) %>%
  select(city_state,term, log_OR = estimate, OR, p.value, conf_low, conf_high) %>% 
  filter(term == "victim_sexMale")
```
```{r}
all_city_model%>%
  mutate(
    city_state = fct_reorder(city_state, OR)
  ) %>%
  ggplot(aes(x = OR, y = city_state)) +
  geom_point() +
  geom_errorbar(aes(xmin = conf_low, xmax = conf_high)) +
  labs(title = "OR of solved cases for male and female victims",
       x="City_state",
       y="Odds_ratio"
         )
```

#problem3
Load and clean the data for regression analysis (i.e. convert numeric to factor where appropriate, check for missing data, etc.).

Propose a _regression model_ for birthweight. This model may be based on a hypothesized structure for the factors that underly birthweight, on a data-driven model-building process, or a combination of the two. Describe your modeling process and show a plot of model _residuals against fitted values_ – _use add_predictions_ and _add_residuals_ in making this plot.


## 3.0 reclaim data
```{r}
data_bw <- read.csv("./birthweight.csv")%>% 
  na.omit() %>% 
  mutate(
    babysex = as.factor(babysex),
    frace = as.factor(frace), 
    malform = as.factor(malform),
    mrace = factor(mrace)
    )
```

## 3.1 variables visualization

### 3.1.1 dependent variable visual
```{r}
density_bwt <- data_bw %>% 
  ggplot(aes(x = bwt)) + 
  geom_histogram()
density_bwt
```
From the plot, we can roughly assume that the distribution of bwt follows normal distribution.

### 3.1.2 Independent variable visual

```{r}
density_bhead <- data_bw %>% 
  ggplot(aes(x = bhead)) + 
  geom_histogram()
density_blength <- data_bw %>% 
  ggplot(aes(x = blength)) + 
  geom_histogram()
density_bhead+density_blength
```
From the density distribution plot, we can see that the distribution of bhead variable and blength variable is normal. Thus, we can directly put them into our linear regression model.

## 3.1.3 the relation ship among varaibles
```{r}
data_bw1=data_bw %>% 
  select(bwt,bhead,blength)
plot(data_bw1)
```
From the plot, we can be sure that there is relationship between bwt and blength and the same for bhead. So next step, we can use linear regression model to get the further development,

## 3.2 linear regression
```{r}
set.seed(002)
fit_headlength = lm(bwt ~ bhead+blength, data = data_bw)
summary(fit_headlength)
fit_headlength %>% 
  broom::glance()%>% 
  broom::tidy()
```

## 3.3 diagnosis for linear regression model 
```{r}
data_bw %>% 
  modelr::add_residuals(fit_headlength) %>% 
  modelr::add_predictions(fit_headlength) %>%
  ggplot(aes(x = pred, y = resid)) + 
  geom_point()+
  labs(
   title="head-lengh of residual vs fitted value",
   y="Residual" ,
   x="fitted value"
  )
  
```

Compare your model to two others:

One using length at birth and gestational age as predictors (main effects only)
One using head circumference, length, sex, and all interactions (including the three-way interaction) between these

```{r}

```

